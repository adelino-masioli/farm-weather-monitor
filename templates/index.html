<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Weather Monitor - Alentejo Region</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .weather-card {
            transition: transform 0.2s;
            margin-bottom: 20px;
        }
        .weather-card:hover {
            transform: translateY(-5px);
        }
        .recommendation-item {
            border-left: 4px solid #0d6efd;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .weather-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        .metric-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background-color: #f8f9fa;
            margin-bottom: 15px;
        }
        .location-info {
            color: #6c757d;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-cloud-sun"></i> Farm Weather Monitor - Alentejo Region
            </span>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="location-info text-center">
            <i class="fas fa-map-marker-alt"></i> 
            Location: <span id="coordinates">{{ farm_lat }}°N, {{ farm_lon }}°W</span>
        </div>

        <div class="row">
            <!-- Main Weather Card -->
            <div class="col-md-6 mb-4">
                <div class="card weather-card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-cloud"></i> Current Weather</h5>
                    </div>
                    <div class="card-body text-center">
                        <div id="weather-icon" class="weather-icon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <h2 id="temperature" class="mb-3">--°C</h2>
                        <h4 id="description" class="text-muted mb-4">--</h4>
                        <div class="row">
                            <div class="col-6">
                                <div class="metric-card">
                                    <i class="fas fa-tint"></i>
                                    <h5>Humidity</h5>
                                    <h3 id="humidity">--%</h3>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="metric-card">
                                    <i class="fas fa-wind"></i>
                                    <h5>Wind</h5>
                                    <h3 id="wind">-- m/s</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Metrics -->
            <div class="col-md-6 mb-4">
                <div class="card weather-card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Detailed Metrics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="metric-card">
                                    <i class="fas fa-temperature-high"></i>
                                    <h5>Feels Like</h5>
                                    <h3 id="feels-like">--°C</h3>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-card">
                                    <i class="fas fa-compress-arrows-alt"></i>
                                    <h5>Pressure</h5>
                                    <h3 id="pressure">-- hPa</h3>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-card">
                                    <i class="fas fa-eye"></i>
                                    <h5>Visibility</h5>
                                    <h3 id="visibility">-- km</h3>
                                </div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-card">
                                    <i class="fas fa-cloud-rain"></i>
                                    <h5>Rain (1h)</h5>
                                    <h3 id="rain">-- mm</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="col-12 mb-4">
                <div class="card weather-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-list-check"></i> Agricultural Recommendations</h5>
                    </div>
                    <div class="card-body">
                        <div id="recommendations-list">
                            <p class="text-center text-muted">Loading recommendations...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Map -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card weather-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Farm Location</h5>
                    </div>
                    <div class="card-body">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sun Information -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card weather-card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-sun"></i> Sun Schedule</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center">
                                <i class="fas fa-sunrise fa-2x mb-2"></i>
                                <h5>Sunrise</h5>
                                <p id="sunrise">--:--</p>
                            </div>
                            <div class="col-6 text-center">
                                <i class="fas fa-sunset fa-2x mb-2"></i>
                                <h5>Sunset</h5>
                                <p id="sunset">--:--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Wind Information -->
            <div class="col-md-6">
                <div class="card weather-card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-wind"></i> Wind Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6 text-center">
                                <i class="fas fa-compass fa-2x mb-2"></i>
                                <h5>Direction</h5>
                                <p id="wind-direction">--°</p>
                            </div>
                            <div class="col-6 text-center">
                                <i class="fas fa-wind fa-2x mb-2"></i>
                                <h5>Gust</h5>
                                <p id="wind-gust">-- m/s</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Last Updated -->
        <div class="text-center text-muted mt-3 mb-4">
            <small>Last updated: <span id="last-updated">--</span></small>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map
        const lat = {{ farm_lat }};
        const lon = {{ farm_lon }};
        const map = L.map('map').setView([lat, lon], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'OpenStreetMap contributors'
        }).addTo(map);

        // Add marker for farm location
        L.marker([lat, lon])
            .addTo(map)
            .bindPopup('Farm Location - Alentejo Region')
            .openPopup();

        function getWindDirection(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(((degrees %= 360) < 0 ? degrees + 360 : degrees) / 22.5) % 16;
            return `${degrees}° ${directions[index]}`;
        }

        function formatTime(timestamp) {
            return new Date(timestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function updateWeatherDisplay(data) {
            // Main weather information
            document.getElementById('temperature').textContent = 
                `${Math.round(data.weather.main.temp)}°C`;
            document.getElementById('description').textContent = 
                data.weather.weather[0].description.charAt(0).toUpperCase() + 
                data.weather.weather[0].description.slice(1);
            document.getElementById('humidity').textContent = 
                `${data.weather.main.humidity}%`;
            document.getElementById('wind').textContent = 
                `${data.weather.wind.speed} m/s`;

            // Detailed metrics
            document.getElementById('feels-like').textContent = 
                `${Math.round(data.weather.main.feels_like)}°C`;
            document.getElementById('pressure').textContent = 
                `${data.weather.main.pressure} hPa`;
            document.getElementById('visibility').textContent = 
                `${(data.weather.visibility / 1000).toFixed(1)} km`;
            document.getElementById('rain').textContent = 
                data.weather.rain ? `${data.weather.rain['1h']} mm` : '0 mm';

            // Wind details
            document.getElementById('wind-direction').textContent = 
                getWindDirection(data.weather.wind.deg);
            document.getElementById('wind-gust').textContent = 
                data.weather.wind.gust ? `${data.weather.wind.gust} m/s` : 'N/A';

            // Sun schedule
            document.getElementById('sunrise').textContent = 
                formatTime(data.weather.sys.sunrise);
            document.getElementById('sunset').textContent = 
                formatTime(data.weather.sys.sunset);

            // Update weather icon
            const iconMap = {
                '01d': 'sun',
                '01n': 'moon',
                '02d': 'cloud-sun',
                '02n': 'cloud-moon',
                '03d': 'cloud',
                '03n': 'cloud',
                '04d': 'clouds',
                '04n': 'clouds',
                '09d': 'cloud-showers-heavy',
                '09n': 'cloud-showers-heavy',
                '10d': 'cloud-sun-rain',
                '10n': 'cloud-moon-rain',
                '11d': 'bolt',
                '11n': 'bolt',
                '13d': 'snowflake',
                '13n': 'snowflake',
                '50d': 'smog',
                '50n': 'smog'
            };
            const iconCode = data.weather.weather[0].icon;
            const iconClass = iconMap[iconCode] || 'question';
            document.getElementById('weather-icon').innerHTML = 
                `<i class="fas fa-${iconClass}"></i>`;

            // Update recommendations
            const recommendationsList = document.getElementById('recommendations-list');
            if (data.recommendations && data.recommendations.length > 0) {
                recommendationsList.innerHTML = data.recommendations
                    .map(rec => `<div class="recommendation-item">
                        <i class="fas fa-check-circle text-success"></i> ${rec}
                    </div>`)
                    .join('');
            } else {
                recommendationsList.innerHTML = 
                    '<p class="text-center text-muted">No current recommendations</p>';
            }

            // Update timestamp
            document.getElementById('last-updated').textContent = 
                new Date().toLocaleString();
        }

        function fetchWeatherData() {
            fetch('/api/weather')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error:', data.error);
                        return;
                    }
                    updateWeatherDisplay(data);
                })
                .catch(error => console.error('Error:', error));
        }

        // Initial fetch
        fetchWeatherData();

        // Refresh every 5 minutes
        setInterval(fetchWeatherData, 5 * 60 * 1000);
    </script>
</body>
</html>
